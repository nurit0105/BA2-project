<!DOCTYPE html>
<html lang="en">
<head>
    <title>Handpose Finger Detection</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-converter"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/handpose"></script>
    <style>
        #videoCanvasContainer {
            position: relative;
            width: 640px;
            height: 480px;
        }

        canvas, video {
            position: absolute;
            top: 0;
            left: 0;
        }

        #status {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            background: rgba(0, 0, 0, 0.5);
            padding: 5px;
            font-family: monospace;
            z-index: 2;
        }

        section {
            margin-top: 20px;
        }

        .circle {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background-color: #3498db;
            display: inline-block;
            margin: 20px;
        }

        .circle.red {
            background-color: #e74c3c;
        }

        .circle.green {
            background-color: green;
        }

         .circle.selected {
            outline: 3px solid yellow;
        }
    </style>
</head>
<body>
<section id="videoCanvasContainer">
    <video id="video" autoplay playsinline width="640" height="480"></video>
    <canvas id="canvas" width="640" height="480"></canvas>
    <div id="status">Loading...</div>
</section>
<section>
    <div class="circle" id="1"></div>
    <div class="circle" id="2"></div>
    <input type="button" value="Test Performance" onclick="testPerformance()"/>
    <div id="results"></div>
    <div id="confusionMatrixTable"></div>
    <div id="metricsDisplay" style="margin-top: 20px;"></div>
</section>

<script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const statusEl = document.getElementById('status');

    async function setupCamera() {
        const stream = await navigator.mediaDevices.getUserMedia({video: true});
        video.srcObject = stream;
        return new Promise(resolve => {
            video.onloadedmetadata = () => resolve(video);
        });
    }

    function isFingerUp(landmarks, tip, pip) {
        return landmarks[tip][1] < landmarks[pip][1]; // y: smaller is higher
    }

    let selectedCircle = document.getElementById('1');
    selectedCircle.style.outline = '5px solid yellow';

    async function main() {
        await setupCamera();
        const model = await handpose.load();
        statusEl.textContent = 'Model Loaded';

        async function detect() {
            const predictions = await model.estimateHands(video, true);
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            if (predictions.length > 0) {
                const landmarks = predictions[0].landmarks;

                // Draw landmarks
                for (let i = 0; i < landmarks.length; i++) {
                    const [x, y] = landmarks[i];
                    ctx.beginPath();
                    ctx.arc(x, y, 5, 0, 2 * Math.PI);
                    ctx.fillStyle = 'lime';
                    ctx.fill();
                    ctx.fillText(i, x + 5, y - 5);
                }

                // Finger detection
                const index = isFingerUp(landmarks, 8, 5);
                const middle = isFingerUp(landmarks, 12, 9);
                const ring = isFingerUp(landmarks, 16, 13);
                const pinky = isFingerUp(landmarks, 20, 18);

                const fingersUp = [index, middle, ring, pinky].filter(Boolean).length;

                document.querySelectorAll('.circle').forEach(circle => {
                    circle.style.outline = '';
                });

                handleFingerDetection(fingersUp);

                // display which fingers are up
                const labels = ['Index', 'Middle', 'Ring', 'Pinky'];
                const statusText = [index, middle, ring, pinky]
                    .map((val, i) => val ? labels[i] : null)
                    .filter(Boolean)
                    .join(', ');
                statusEl.textContent = statusText || 'No fingers up';
            }

            requestAnimationFrame(detect);
        }

        detect();
    }

   function handleFingerDetection(fingersUp) {
        let newSelection;

        if (fingersUp === 1) {
            newSelection = document.getElementById('1');
            if (selectedCircle !== newSelection) {
                selectedCircle.classList.remove('selected');
                selectedCircle = newSelection;
                selectedCircle.classList.add('selected');
            }
            console.log("Showing One Finger");
        } else if (fingersUp === 2) {
            newSelection = document.getElementById('2');
            if (selectedCircle !== newSelection) {
                selectedCircle.classList.remove('selected');
                selectedCircle = newSelection;
                selectedCircle.classList.add('selected');
            }
            console.log("Showing Two Fingers");
        } else if (fingersUp === 3) {
            selectedCircle.classList.remove('red');
            selectedCircle.classList.add('green');
            console.log("Showing Three Fingers");
        } else if (fingersUp === 4) {
            selectedCircle.classList.remove('green');
            selectedCircle.classList.add('red');
            console.log("Showing Four Fingers");
        } else {
            console.log("Finger Count out of Scope");
        }
    }

    main();
</script>
</body>
</html>
